# Database Schema Documentation: Projection Calibration

## Overview

The Projection Calibration system introduces a new database table (`projection_calibration`) and extends the existing `player_pools` table with additional columns to store both original and calibrated projection values. This design preserves historical data integrity while enabling position-based projection adjustments.

---

## Tables

### 1. projection_calibration

Stores position-based calibration factors for adjusting player projections on a per-week basis.

#### Schema

```sql
CREATE TABLE projection_calibration (
    id SERIAL PRIMARY KEY,
    week_id INTEGER NOT NULL REFERENCES weeks(id) ON DELETE CASCADE,
    position VARCHAR(10) NOT NULL,
    floor_adjustment_percent DECIMAL(5,2) NOT NULL,
    median_adjustment_percent DECIMAL(5,2) NOT NULL,
    ceiling_adjustment_percent DECIMAL(5,2) NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT unique_week_position UNIQUE (week_id, position),
    CONSTRAINT check_position CHECK (position IN ('QB', 'RB', 'WR', 'TE', 'K', 'DST')),
    CONSTRAINT check_adjustment_range CHECK (
        floor_adjustment_percent BETWEEN -50 AND 50 AND
        median_adjustment_percent BETWEEN -50 AND 50 AND
        ceiling_adjustment_percent BETWEEN -50 AND 50
    )
);
```

#### Columns

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | SERIAL | No | auto-increment | Primary key |
| week_id | INTEGER | No | - | Foreign key to weeks table |
| position | VARCHAR(10) | No | - | NFL position (QB, RB, WR, TE, K, DST) |
| floor_adjustment_percent | DECIMAL(5,2) | No | - | Floor projection adjustment percentage (-50 to +50) |
| median_adjustment_percent | DECIMAL(5,2) | No | - | Median projection adjustment percentage (-50 to +50) |
| ceiling_adjustment_percent | DECIMAL(5,2) | No | - | Ceiling projection adjustment percentage (-50 to +50) |
| is_active | BOOLEAN | No | true | Flag indicating if calibration should be applied |
| created_at | TIMESTAMP | No | CURRENT_TIMESTAMP | Record creation timestamp |
| updated_at | TIMESTAMP | No | CURRENT_TIMESTAMP | Last update timestamp |

#### Constraints

**Primary Key:**
```sql
PRIMARY KEY (id)
```

**Foreign Key:**
```sql
FOREIGN KEY (week_id) REFERENCES weeks(id) ON DELETE CASCADE
```
- Cascading delete: When a week is deleted, all associated calibrations are automatically removed

**Unique Constraint:**
```sql
CONSTRAINT unique_week_position UNIQUE (week_id, position)
```
- Ensures only one calibration record per position per week
- Prevents duplicate calibration configurations

**Check Constraints:**

1. Position validation:
```sql
CONSTRAINT check_position CHECK (position IN ('QB', 'RB', 'WR', 'TE', 'K', 'DST'))
```
- Enforces valid NFL positions only

2. Adjustment range validation:
```sql
CONSTRAINT check_adjustment_range CHECK (
    floor_adjustment_percent BETWEEN -50 AND 50 AND
    median_adjustment_percent BETWEEN -50 AND 50 AND
    ceiling_adjustment_percent BETWEEN -50 AND 50
)
```
- Prevents extreme calibration values that could produce unrealistic results

#### Indexes

**Index 1: Week lookup**
```sql
CREATE INDEX idx_projection_calibration_week
ON projection_calibration(week_id);
```
- Optimizes queries for retrieving all calibrations for a specific week
- Used by import process to fetch calibration factors

**Index 2: Active calibration lookup**
```sql
CREATE INDEX idx_projection_calibration_active
ON projection_calibration(week_id, is_active);
```
- Optimizes queries for active calibrations only
- Composite index supports filtering by both week and active status
- Primary query pattern: `WHERE week_id = ? AND is_active = true`

#### Example Data

```sql
-- Week 8 calibration factors
INSERT INTO projection_calibration
(week_id, position, floor_adjustment_percent, median_adjustment_percent,
 ceiling_adjustment_percent, is_active)
VALUES
(8, 'QB', 5.0, 0.0, -5.0, true),
(8, 'RB', 10.0, 8.0, -10.0, true),
(8, 'WR', 8.0, 5.0, -12.0, true),
(8, 'TE', 10.0, 7.0, -10.0, true),
(8, 'K', 0.0, 0.0, 0.0, true),
(8, 'DST', 0.0, 0.0, 0.0, true);
```

---

### 2. player_pools (Extended)

Extended with calibration-related columns to store both original and calibrated projection values.

#### New Columns Added

```sql
ALTER TABLE player_pools
ADD COLUMN projection_floor_original FLOAT,
ADD COLUMN projection_floor_calibrated FLOAT,
ADD COLUMN projection_median_original FLOAT,
ADD COLUMN projection_median_calibrated FLOAT,
ADD COLUMN projection_ceiling_original FLOAT,
ADD COLUMN projection_ceiling_calibrated FLOAT,
ADD COLUMN calibration_applied BOOLEAN DEFAULT false;
```

#### Calibration Column Details

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| projection_floor_original | FLOAT | Yes | NULL | Original floor projection from data source |
| projection_floor_calibrated | FLOAT | Yes | NULL | Calibrated floor projection after adjustment |
| projection_median_original | FLOAT | Yes | NULL | Original median/projection from data source |
| projection_median_calibrated | FLOAT | Yes | NULL | Calibrated median projection after adjustment |
| projection_ceiling_original | FLOAT | Yes | NULL | Original ceiling projection from data source |
| projection_ceiling_calibrated | FLOAT | Yes | NULL | Calibrated ceiling projection after adjustment |
| calibration_applied | BOOLEAN | No | false | Flag indicating if calibration was applied to this player |

#### Index

**Calibration query optimization:**
```sql
CREATE INDEX idx_player_pools_calibration
ON player_pools(week_id, calibration_applied);
```
- Optimizes queries filtering by calibration status
- Supports queries like: "Get all calibrated players for week X"

#### Data Flow

**1. Import with Active Calibration:**
```
Original Data → Store in *_original columns
              → Apply calibration formula
              → Store in *_calibrated columns
              → Set calibration_applied = true
```

**2. Import without Calibration:**
```
Original Data → Store in *_original columns
              → Copy to *_calibrated columns (no adjustment)
              → Set calibration_applied = false
```

**3. Historical Data (Backfilled):**
```
Existing Data → Copy floor/projection/ceiling to *_original columns
              → Leave *_calibrated as NULL
              → Set calibration_applied = false
```

#### Example Query Patterns

**Retrieve calibrated projections with fallback:**
```sql
SELECT
    name,
    position,
    COALESCE(projection_floor_calibrated, projection_floor_original, floor) as floor,
    COALESCE(projection_median_calibrated, projection_median_original, projection) as projection,
    COALESCE(projection_ceiling_calibrated, projection_ceiling_original, ceiling) as ceiling,
    calibration_applied
FROM player_pools
WHERE week_id = 8;
```

**Count calibrated vs non-calibrated players:**
```sql
SELECT
    calibration_applied,
    COUNT(*) as player_count
FROM player_pools
WHERE week_id = 8
GROUP BY calibration_applied;
```

**Compare original vs calibrated values:**
```sql
SELECT
    name,
    position,
    projection_median_original,
    projection_median_calibrated,
    (projection_median_calibrated - projection_median_original) as adjustment_amount,
    ROUND(
        ((projection_median_calibrated - projection_median_original) / projection_median_original) * 100,
        2
    ) as adjustment_percent
FROM player_pools
WHERE week_id = 8
  AND calibration_applied = true
  AND projection_median_original IS NOT NULL;
```

---

## Entity Relationship Diagram

```
┌─────────────────┐
│     weeks       │
│─────────────────│
│ id (PK)         │
│ season          │
│ week_number     │
│ ...             │
└────────┬────────┘
         │
         │ 1:N
         │
    ┌────┴────────────────────────────────────┐
    │                                         │
    │                                         │
┌───┴──────────────────────┐    ┌────────────┴─────────────┐
│ projection_calibration   │    │      player_pools        │
│──────────────────────────│    │──────────────────────────│
│ id (PK)                  │    │ id (PK)                  │
│ week_id (FK) ───────────────┐ │ week_id (FK) ────────────│
│ position                 │  │ │ name                     │
│ floor_adjustment_%       │  │ │ position                 │
│ median_adjustment_%      │  │ │ ...                      │
│ ceiling_adjustment_%     │  │ │ projection_floor_orig    │
│ is_active                │  └─│ projection_floor_cal     │
│ created_at               │    │ projection_median_orig   │
│ updated_at               │    │ projection_median_cal    │
└──────────────────────────┘    │ projection_ceiling_orig  │
                                │ projection_ceiling_cal   │
                                │ calibration_applied      │
                                └──────────────────────────┘
```

### Relationships

1. **weeks → projection_calibration** (1:N)
   - One week can have multiple calibration records (one per position)
   - CASCADE DELETE: Deleting a week removes all associated calibrations

2. **weeks → player_pools** (1:N)
   - One week can have multiple players in the pool
   - No direct FK between projection_calibration and player_pools
   - Relationship is implicit through week_id and position matching

---

## Calibration Data Flow

### 1. Admin Configuration
```
Admin UI
  → POST /api/calibration/{week_id}/batch
  → Inserts/Updates projection_calibration table
  → Sets is_active = true
```

### 2. Data Import Process
```
DraftKings/LineStar File Upload
  → Parse player data
  → For each player:
      1. Store original projections in *_original columns
      2. Query projection_calibration for player's position
      3. If calibration exists and is_active:
         - Apply formula: calibrated = original * (1 + adjustment% / 100)
         - Store in *_calibrated columns
         - Set calibration_applied = true
      4. If no calibration:
         - Copy original to calibrated columns
         - Set calibration_applied = false
  → Bulk insert into player_pools
```

### 3. Smart Score Calculation
```
Smart Score Service
  → Query player_pools with COALESCE:
      COALESCE(projection_median_calibrated, projection_median_original, projection)
  → Use calibrated values when available
  → Fall back to original if calibrated is NULL
  → Calculate Smart Score with calibrated projections
```

### 4. Lineup Optimization
```
Lineup Optimizer
  → Receives PlayerScoreResponse from Smart Score Service
  → Uses calibrated projections automatically
  → Generates optimized lineups based on calibrated data
```

---

## Migration Strategy

### Migration Files

1. **019_create_projection_calibration_table.py**
   - Creates projection_calibration table
   - Adds constraints and indexes
   - No data modifications

2. **020_add_calibrated_projections_to_player_pools.py**
   - Adds 7 new columns to player_pools
   - Backfills existing data: copies floor/projection/ceiling to *_original columns
   - Sets calibration_applied = false for all existing records
   - Creates calibration index

3. **021_seed_default_calibration_values.py**
   - Inserts default calibration values for current active week
   - Sets is_active = true
   - Uses position-specific defaults based on ETR analysis

### Running Migrations

```bash
# Apply all calibration migrations
alembic upgrade head

# Check migration status
alembic current

# Rollback if needed
alembic downgrade 018
```

### Backfill Script

For historical weeks that need calibration:

```sql
-- Copy existing projections to original columns (if not already done)
UPDATE player_pools
SET
    projection_floor_original = floor,
    projection_median_original = projection,
    projection_ceiling_original = ceiling,
    calibration_applied = false
WHERE projection_floor_original IS NULL;
```

---

## Performance Considerations

### Query Optimization

**1. Use Indexes Effectively**
```sql
-- GOOD: Uses idx_projection_calibration_active
SELECT * FROM projection_calibration
WHERE week_id = 8 AND is_active = true;

-- GOOD: Uses idx_player_pools_calibration
SELECT * FROM player_pools
WHERE week_id = 8 AND calibration_applied = true;
```

**2. COALESCE for Backward Compatibility**
```sql
-- Efficient fallback logic
SELECT
    COALESCE(projection_median_calibrated, projection_median_original, projection) as projection
FROM player_pools
WHERE week_id = 8;
```

**3. Bulk Operations**
```sql
-- GOOD: Single batch insert with calibration
INSERT INTO player_pools (name, position, projection_floor_original, ...)
VALUES
    ('Patrick Mahomes', 'QB', 18.5, ...),
    ('Christian McCaffrey', 'RB', 12.3, ...),
    ...;

-- AVOID: Individual inserts in loop
```

### Storage Considerations

**Column Storage:**
- Each FLOAT column: ~8 bytes
- 6 new FLOAT columns per player: ~48 bytes
- 1 BOOLEAN column: ~1 byte
- Total overhead per player: ~49 bytes

**Example Storage Impact:**
- 500 players/week: ~24.5 KB additional storage
- 18 weeks/season: ~441 KB additional storage
- Negligible impact on modern databases

**Index Storage:**
- projection_calibration table: ~2 indexes on small table (6 positions × N weeks)
- player_pools: 1 additional composite index
- Minimal impact, significant query performance gain

---

## Data Integrity

### Constraints Ensuring Data Quality

1. **Foreign Key Cascade:** Prevents orphaned calibration records
2. **Unique Constraint:** Prevents duplicate calibration for same position/week
3. **Check Constraints:** Ensures adjustment percentages within reasonable range
4. **NOT NULL Constraints:** Prevents incomplete calibration records

### Validation Layers

1. **Database Level:** CHECK constraints, foreign keys
2. **Application Level:** Pydantic schema validation
3. **API Level:** Request validation before database operations

### Data Consistency

**Transaction Management:**
- All calibration updates wrapped in transactions
- Batch operations: all-or-nothing commits
- Import process: rollback on any calibration failure

**Audit Trail:**
- `created_at` timestamp: When calibration was first created
- `updated_at` timestamp: When calibration was last modified
- Can track calibration changes over time

---

## Maintenance

### Routine Tasks

**1. Cleanup Old Calibrations**
```sql
-- Remove calibrations for weeks older than 1 year
DELETE FROM projection_calibration
WHERE week_id IN (
    SELECT id FROM weeks
    WHERE start_date < NOW() - INTERVAL '1 year'
);
```

**2. Monitor Calibration Usage**
```sql
-- Check which weeks have active calibration
SELECT
    w.week_number,
    COUNT(DISTINCT pc.position) as positions_configured,
    BOOL_OR(pc.is_active) as has_active_calibration
FROM weeks w
LEFT JOIN projection_calibration pc ON w.id = pc.week_id
GROUP BY w.week_number
ORDER BY w.week_number DESC
LIMIT 10;
```

**3. Analyze Calibration Impact**
```sql
-- Compare average projections: original vs calibrated
SELECT
    position,
    AVG(projection_median_original) as avg_original,
    AVG(projection_median_calibrated) as avg_calibrated,
    AVG(projection_median_calibrated - projection_median_original) as avg_adjustment
FROM player_pools
WHERE week_id = 8 AND calibration_applied = true
GROUP BY position;
```

---

## Troubleshooting

### Common Issues

**Issue 1: Calibration not applying during import**
```sql
-- Check if calibration exists and is active
SELECT * FROM projection_calibration
WHERE week_id = 8 AND is_active = true;

-- Check if players have calibration_applied flag
SELECT calibration_applied, COUNT(*)
FROM player_pools
WHERE week_id = 8
GROUP BY calibration_applied;
```

**Issue 2: Unexpected calibration values**
```sql
-- Verify calibration factors
SELECT position,
       floor_adjustment_percent,
       median_adjustment_percent,
       ceiling_adjustment_percent
FROM projection_calibration
WHERE week_id = 8;

-- Test calculation manually
SELECT
    name,
    projection_median_original,
    projection_median_original * (1 + 8.0/100) as expected_calibrated,
    projection_median_calibrated as actual_calibrated
FROM player_pools
WHERE week_id = 8 AND position = 'RB' AND calibration_applied = true
LIMIT 5;
```

**Issue 3: Missing original values**
```sql
-- Check for NULL original values
SELECT COUNT(*)
FROM player_pools
WHERE week_id = 8
  AND (projection_floor_original IS NULL
   OR projection_median_original IS NULL
   OR projection_ceiling_original IS NULL);
```

---

## Schema Version

**Current Version:** 1.0
**Migration Revisions:** 019, 020, 021
**Last Updated:** 2025-11-01

---

## References

- API Documentation: See `11.1-API-Documentation.md`
- User Guide: See `11.3-User-Guide.md`
- Developer Documentation: See `11.6-Developer-Documentation.md`
