# API Documentation: Projection Calibration

## Overview

The Projection Calibration API provides endpoints for managing position-based calibration factors that adjust player projection values (floor, median, ceiling) to improve lineup optimization accuracy. All endpoints are RESTful and return JSON responses.

**Base URL:** `/api/calibration`

**Authentication:** All endpoints require authentication (inherits from application authentication)

**Authorization:** Admin privileges required for POST operations (create, update, reset)

---

## Endpoints

### 1. GET /api/calibration/{week_id}

Retrieves all calibration factors for a specific week across all positions.

#### Parameters

| Name | Type | Location | Required | Description |
|------|------|----------|----------|-------------|
| week_id | integer | path | Yes | Week ID from weeks table |

#### Success Response (200 OK)

```json
{
  "success": true,
  "week_id": 8,
  "calibrations": [
    {
      "id": 1,
      "week_id": 8,
      "position": "QB",
      "floor_adjustment_percent": 5.0,
      "median_adjustment_percent": 0.0,
      "ceiling_adjustment_percent": -5.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    },
    {
      "id": 2,
      "week_id": 8,
      "position": "RB",
      "floor_adjustment_percent": 10.0,
      "median_adjustment_percent": 8.0,
      "ceiling_adjustment_percent": -10.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    }
  ]
}
```

#### Error Responses

**404 Not Found** - Week does not exist
```json
{
  "detail": "Week 8 not found"
}
```

**500 Internal Server Error** - Server error
```json
{
  "detail": "Failed to retrieve calibrations: [error message]"
}
```

#### Example Usage

```bash
curl -X GET "https://api.example.com/api/calibration/8" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

```python
import requests

response = requests.get(
    "https://api.example.com/api/calibration/8",
    headers={"Authorization": "Bearer YOUR_TOKEN"}
)
calibrations = response.json()
```

---

### 2. POST /api/calibration/{week_id}

Creates or updates calibration for a single position. Uses UPSERT logic (INSERT ON CONFLICT UPDATE).

#### Parameters

| Name | Type | Location | Required | Description |
|------|------|----------|----------|-------------|
| week_id | integer | path | Yes | Week ID from weeks table |

#### Request Body

```json
{
  "position": "RB",
  "floor_adjustment_percent": 10.0,
  "median_adjustment_percent": 8.0,
  "ceiling_adjustment_percent": -10.0,
  "is_active": true
}
```

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| position | string | Yes | QB, RB, WR, TE, K, DST | NFL position |
| floor_adjustment_percent | float | Yes | -50.0 to +50.0 | Floor adjustment percentage |
| median_adjustment_percent | float | Yes | -50.0 to +50.0 | Median adjustment percentage |
| ceiling_adjustment_percent | float | Yes | -50.0 to +50.0 | Ceiling adjustment percentage |
| is_active | boolean | Yes | true or false | Calibration active flag |

#### Success Response (200 OK)

```json
{
  "id": 2,
  "week_id": 8,
  "position": "RB",
  "floor_adjustment_percent": 10.0,
  "median_adjustment_percent": 8.0,
  "ceiling_adjustment_percent": -10.0,
  "is_active": true,
  "created_at": "2025-11-01T12:00:00.000Z",
  "updated_at": "2025-11-01T12:00:00.000Z"
}
```

#### Error Responses

**400 Bad Request** - Invalid input data
```json
{
  "detail": [
    {
      "loc": ["body", "floor_adjustment_percent"],
      "msg": "ensure this value is less than or equal to 50.0",
      "type": "value_error.number.not_le"
    }
  ]
}
```

**404 Not Found** - Week does not exist
```json
{
  "detail": "Week 8 not found"
}
```

**422 Unprocessable Entity** - Validation error
```json
{
  "detail": "Adjustment percentage must be between -50 and +50"
}
```

**500 Internal Server Error** - Server error
```json
{
  "detail": "Failed to save calibration: [error message]"
}
```

#### Example Usage

```bash
curl -X POST "https://api.example.com/api/calibration/8" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "position": "RB",
    "floor_adjustment_percent": 10.0,
    "median_adjustment_percent": 8.0,
    "ceiling_adjustment_percent": -10.0,
    "is_active": true
  }'
```

```python
import requests

data = {
    "position": "RB",
    "floor_adjustment_percent": 10.0,
    "median_adjustment_percent": 8.0,
    "ceiling_adjustment_percent": -10.0,
    "is_active": True
}

response = requests.post(
    "https://api.example.com/api/calibration/8",
    headers={"Authorization": "Bearer YOUR_TOKEN"},
    json=data
)
calibration = response.json()
```

---

### 3. POST /api/calibration/{week_id}/batch

Batch creates or updates calibrations for multiple positions in a single transaction.

#### Parameters

| Name | Type | Location | Required | Description |
|------|------|----------|----------|-------------|
| week_id | integer | path | Yes | Week ID from weeks table |

#### Request Body

```json
{
  "calibrations": [
    {
      "position": "QB",
      "floor_adjustment_percent": 5.0,
      "median_adjustment_percent": 0.0,
      "ceiling_adjustment_percent": -5.0,
      "is_active": true
    },
    {
      "position": "RB",
      "floor_adjustment_percent": 10.0,
      "median_adjustment_percent": 8.0,
      "ceiling_adjustment_percent": -10.0,
      "is_active": true
    },
    {
      "position": "WR",
      "floor_adjustment_percent": 8.0,
      "median_adjustment_percent": 5.0,
      "ceiling_adjustment_percent": -12.0,
      "is_active": true
    }
  ]
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| calibrations | array | Yes | List of calibration objects (same structure as single POST) |

**Validation Rules:**
- Calibrations list cannot be empty
- No duplicate positions allowed in the list
- Each calibration must follow the same validation as single POST

#### Success Response (200 OK)

```json
{
  "success": true,
  "week_id": 8,
  "calibrations": [
    {
      "id": 1,
      "week_id": 8,
      "position": "QB",
      "floor_adjustment_percent": 5.0,
      "median_adjustment_percent": 0.0,
      "ceiling_adjustment_percent": -5.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    },
    {
      "id": 2,
      "week_id": 8,
      "position": "RB",
      "floor_adjustment_percent": 10.0,
      "median_adjustment_percent": 8.0,
      "ceiling_adjustment_percent": -10.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    }
  ]
}
```

#### Error Responses

**400 Bad Request** - Invalid input or duplicate positions
```json
{
  "detail": "Calibrations list contains duplicate positions"
}
```

**404 Not Found** - Week does not exist
```json
{
  "detail": "Week 8 not found"
}
```

**500 Internal Server Error** - Server error (transaction rolled back)
```json
{
  "detail": "Failed to batch update calibrations: [error message]"
}
```

#### Transaction Behavior

All calibrations are processed in a single database transaction. If any calibration fails:
- All changes are rolled back
- No partial updates are committed
- Error response indicates the failure

#### Example Usage

```bash
curl -X POST "https://api.example.com/api/calibration/8/batch" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "calibrations": [
      {
        "position": "QB",
        "floor_adjustment_percent": 5.0,
        "median_adjustment_percent": 0.0,
        "ceiling_adjustment_percent": -5.0,
        "is_active": true
      }
    ]
  }'
```

```python
import requests

data = {
    "calibrations": [
        {
            "position": "QB",
            "floor_adjustment_percent": 5.0,
            "median_adjustment_percent": 0.0,
            "ceiling_adjustment_percent": -5.0,
            "is_active": True
        },
        {
            "position": "RB",
            "floor_adjustment_percent": 10.0,
            "median_adjustment_percent": 8.0,
            "ceiling_adjustment_percent": -10.0,
            "is_active": True
        }
    ]
}

response = requests.post(
    "https://api.example.com/api/calibration/8/batch",
    headers={"Authorization": "Bearer YOUR_TOKEN"},
    json=data
)
result = response.json()
```

---

### 4. GET /api/calibration/{week_id}/status

Returns calibration status for a week, indicating if calibration is active and how many positions are configured.

#### Parameters

| Name | Type | Location | Required | Description |
|------|------|----------|----------|-------------|
| week_id | integer | path | Yes | Week ID from weeks table |

#### Success Response (200 OK)

```json
{
  "success": true,
  "week_id": 8,
  "is_active": true,
  "positions_configured": 4,
  "total_positions": 6
}
```

| Field | Type | Description |
|-------|------|-------------|
| success | boolean | Always true for successful requests |
| week_id | integer | Week ID queried |
| is_active | boolean | True if at least one position has active calibration |
| positions_configured | integer | Number of positions with calibration records |
| total_positions | integer | Total NFL positions (always 6: QB, RB, WR, TE, K, DST) |

#### Error Responses

**404 Not Found** - Week does not exist
```json
{
  "detail": "Week 8 not found"
}
```

**500 Internal Server Error** - Server error
```json
{
  "detail": "Failed to retrieve calibration status: [error message]"
}
```

#### Example Usage

```bash
curl -X GET "https://api.example.com/api/calibration/8/status" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

```python
import requests

response = requests.get(
    "https://api.example.com/api/calibration/8/status",
    headers={"Authorization": "Bearer YOUR_TOKEN"}
)
status = response.json()

if status["is_active"]:
    print(f"Calibration active for {status['positions_configured']} positions")
else:
    print("Calibration not active")
```

---

### 5. POST /api/calibration/{week_id}/reset

Resets calibration factors to default values for all positions. Deletes existing calibrations and creates new ones with defaults.

#### Parameters

| Name | Type | Location | Required | Description |
|------|------|----------|----------|-------------|
| week_id | integer | path | Yes | Week ID from weeks table |

#### Success Response (200 OK)

```json
{
  "success": true,
  "message": "Calibration reset to defaults for week 8",
  "calibrations": [
    {
      "id": 1,
      "week_id": 8,
      "position": "QB",
      "floor_adjustment_percent": 5.0,
      "median_adjustment_percent": 0.0,
      "ceiling_adjustment_percent": -5.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    },
    {
      "id": 2,
      "week_id": 8,
      "position": "RB",
      "floor_adjustment_percent": 10.0,
      "median_adjustment_percent": 8.0,
      "ceiling_adjustment_percent": -10.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    },
    {
      "id": 3,
      "week_id": 8,
      "position": "WR",
      "floor_adjustment_percent": 8.0,
      "median_adjustment_percent": 5.0,
      "ceiling_adjustment_percent": -12.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    },
    {
      "id": 4,
      "week_id": 8,
      "position": "TE",
      "floor_adjustment_percent": 10.0,
      "median_adjustment_percent": 7.0,
      "ceiling_adjustment_percent": -10.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    },
    {
      "id": 5,
      "week_id": 8,
      "position": "K",
      "floor_adjustment_percent": 0.0,
      "median_adjustment_percent": 0.0,
      "ceiling_adjustment_percent": 0.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    },
    {
      "id": 6,
      "week_id": 8,
      "position": "DST",
      "floor_adjustment_percent": 0.0,
      "median_adjustment_percent": 0.0,
      "ceiling_adjustment_percent": 0.0,
      "is_active": true,
      "created_at": "2025-11-01T12:00:00.000Z",
      "updated_at": "2025-11-01T12:00:00.000Z"
    }
  ]
}
```

#### Default Calibration Values

| Position | Floor Adj % | Median Adj % | Ceiling Adj % | Rationale |
|----------|-------------|--------------|---------------|-----------|
| QB | +5% | 0% | -5% | Compress range slightly |
| RB | +10% | +8% | -10% | Median too low, range too wide |
| WR | +8% | +5% | -12% | Median skewed low, ceiling too high |
| TE | +10% | +7% | -10% | Similar to RB - median low, range wide |
| K | 0% | 0% | 0% | No observed issues |
| DST | 0% | 0% | 0% | No observed issues |

#### Error Responses

**404 Not Found** - Week does not exist
```json
{
  "detail": "Week 8 not found"
}
```

**500 Internal Server Error** - Server error (transaction rolled back)
```json
{
  "detail": "Failed to reset calibrations: [error message]"
}
```

#### Example Usage

```bash
curl -X POST "https://api.example.com/api/calibration/8/reset" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

```python
import requests

response = requests.post(
    "https://api.example.com/api/calibration/8/reset",
    headers={"Authorization": "Bearer YOUR_TOKEN"}
)
result = response.json()
print(result["message"])
```

---

## Data Models

### CalibrationResponse

```typescript
{
  id: number;                        // Database ID
  week_id: number;                   // Week ID
  position: "QB" | "RB" | "WR" | "TE" | "K" | "DST";
  floor_adjustment_percent: number;  // -50.0 to +50.0
  median_adjustment_percent: number; // -50.0 to +50.0
  ceiling_adjustment_percent: number; // -50.0 to +50.0
  is_active: boolean;
  created_at: string;                // ISO 8601 timestamp
  updated_at: string;                // ISO 8601 timestamp
}
```

### CalibrationStatusResponse

```typescript
{
  success: boolean;
  week_id: number;
  is_active: boolean;
  positions_configured: number;
  total_positions: number;
}
```

---

## Validation Rules

### Position Validation
- Must be one of: QB, RB, WR, TE, K, DST
- Case-sensitive (uppercase only)

### Adjustment Percentage Validation
- Minimum: -50.0
- Maximum: +50.0
- Enforced at API level (Pydantic validation)
- Enforced at database level (CHECK constraint)

### Week Validation
- Week ID must exist in weeks table
- Returns 404 if week not found

### Batch Request Validation
- Calibrations list cannot be empty
- No duplicate positions allowed
- Each calibration validated individually

---

## Error Codes

| HTTP Status | Error Type | Description |
|-------------|------------|-------------|
| 400 | Bad Request | Invalid input data, duplicate positions in batch |
| 404 | Not Found | Week ID does not exist |
| 422 | Unprocessable Entity | Validation error (e.g., percentage out of range) |
| 500 | Internal Server Error | Database error, transaction failure |

---

## Rate Limiting

No rate limiting currently enforced on calibration endpoints. However, batch operations are recommended when updating multiple positions to reduce API calls.

---

## Best Practices

### 1. Use Batch Operations
When updating multiple positions, use the batch endpoint instead of individual POST requests:

```python
# GOOD: Single batch request
requests.post("/api/calibration/8/batch", json={"calibrations": [...]})

# AVOID: Multiple individual requests
for calibration in calibrations:
    requests.post("/api/calibration/8", json=calibration)
```

### 2. Check Status Before Applying
Query calibration status before performing import operations to verify calibration is active:

```python
status = requests.get("/api/calibration/8/status").json()
if status["is_active"]:
    # Proceed with import - calibration will be applied
    pass
else:
    # Import will proceed without calibration
    pass
```

### 3. Handle Errors Gracefully
Always handle potential errors, especially for batch operations:

```python
try:
    response = requests.post("/api/calibration/8/batch", json=data)
    response.raise_for_status()
except requests.exceptions.HTTPError as e:
    print(f"Calibration update failed: {e.response.json()}")
    # Transaction rolled back - no partial updates
```

### 4. Use Reset for Clean Slate
When uncertain about current calibration state, reset to defaults:

```python
# Reset all positions to defaults
requests.post("/api/calibration/8/reset")
```

### 5. Validate Before Submission
Validate adjustment percentages client-side before API submission:

```python
def validate_adjustment(value):
    return -50.0 <= value <= 50.0

if not all(validate_adjustment(adj) for adj in adjustments):
    print("Error: Adjustment must be between -50% and +50%")
    return
```

---

## OpenAPI/Swagger Specification

The Projection Calibration API is documented in the OpenAPI specification at `/api/docs`. Key features:

- Interactive API testing
- Request/response schema validation
- Example requests and responses
- Authentication configuration

Access the interactive documentation at: `https://your-domain.com/api/docs`

---

## Changelog

### Version 1.0 (2025-11-01)
- Initial release of Projection Calibration API
- 5 endpoints: GET, POST, POST batch, GET status, POST reset
- Support for 6 NFL positions: QB, RB, WR, TE, K, DST
- Adjustment range: -50% to +50%
- Transaction-based batch operations
- Default calibration values based on ETR analysis

---

## Support

For API issues or questions:
- Check the OpenAPI documentation at `/api/docs`
- Review the User Guide (11.3) for usage examples
- Contact development team for technical support
